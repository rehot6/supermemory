FROM oven/bun:1-alpine

WORKDIR /app

# 安装系统依赖
RUN apk add --no-cache \
    git \
    curl \
    python3 \
    make \
    g++ \
    libc6-compat

# 配置 bun 使用国内镜像源
# 创建 bunfig.toml 配置文件
# RUN echo 'registry = "https://registry.npmmirror.com/"' > /root/.bunfig.toml

# 复制 package.json 文件
COPY package.json ./
COPY bun.lock* ./
COPY apps/web/package.json ./apps/web/
COPY packages/*/package.json ./packages/*/

# 安装依赖，跳过完整性检查
RUN bun install --ignore-scripts --no-verify

# 复制源代码
COPY . .

# 运行构建脚本
RUN bun run build || echo "Build failed, continuing..."

EXPOSE 3000

CMD ["bun", "run", "dev"]